rules_version = '2';
service cloud.firestore {
  match / databases / { database } / documents {

    // Helper functions
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database) / documents / admins / $(request.auth.uid));
    }

    function isStudent() {
      return request.auth != null &&
        exists(/databases/$(database) / documents / students / $(request.auth.uid));
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Admin collection - only authenticated admins can read/write their own data
    match / admins / { adminId } {
      allow read, write: if isAdmin() && isOwner(adminId);
    }

    // Courses collection - admins can read/write, public can read active courses
    match / courses / { courseId } {
      allow read: if isAdmin() || isStudent() || (request.auth == null && resource.data.status == 'active');
      allow write: if isAdmin();
    }

    // Portfolio collection - admins can read/write, public can read (for website display)
    match / portfolio / { portfolioId } {
      allow read: if true; // Public read access for portfolio display
      allow write: if isAdmin();
    }

    // Students collection - admins can read/write, students can read/update their own data
    match / students / { studentId } {
      allow read: if isAdmin() || isOwner(studentId);
      allow write: if isAdmin() || isOwner(studentId);
    }

    // Enrollments collection - admins can read/write, students can read/write their own enrollments
    match / enrollments / { enrollmentId } {
      allow read: if isAdmin() || isOwner(resource.data.studentId);
      allow create: if isAdmin() || isStudent();
      allow write: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Contact forms and inquiries - public can create, admins can read/manage
    match / contacts / { contactId } {
      allow create: if true; // Anyone can submit contact forms
      allow read, update, delete: if isAdmin();
    }

    // Analytics collection - only admins can read/write
    match / analytics / { analyticsId } {
      allow read, write: if isAdmin();
    }
  }
}
